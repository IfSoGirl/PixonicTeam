/*
 * File: app/controller/LoginController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('PixonicTeam.controller.LoginController', {
    extend: 'Ext.app.Controller',
    alias: 'controller.loginController',

    requires: [
        'Ext.Ajax',
        'PixonicTeam.view.Profile'
    ],

    config: {
        refs: {
            loginBtn: '#loginBtn',
            loginPanel: '#loginPanel',
            successAuth: '#successAuthLabel',
            errorLabel: '#errorLabel',
            mainPanel: '#profilePanel'
        },

        control: {
            "[action=confirm]": {
                tap: 'onButtonTap'
            }
        }
    },

    onButtonTap: function(button, e, eOpts) {
            var params = 'client_id=' + encodeURIComponent(clientId);
            params += '&redirect_uri='+encodeURIComponent(redirectUri);
            params += '&response_type=code';
            params += '&access_type=offline';
            params += '&scope=' + encodeURIComponent(scopes);
            var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;
            var win = window.open(authUrl, '_blank', 'location=no,toolbar=no,width=800, height=800');
            gwin = win;
            var context = this, url;
            var controller = this;


            if ((Ext.os.is.Android) || (Ext.os.is.iOS)) {
                win.addEventListener('loadstart', function (data) {
                    var pos =  data.url.indexOf(redirectUri);
                    if (pos === 0) {
                        win.close();
                        url = data.url;
                        controller.getTokenFromUrl(url);
                    }
                });
            }
            else {
                var repeat = setInterval(function () {
                    var pos = -1;
                    if(!win || !win.document){
                        return;
                    }
                    if (win)
                       pos =  win.document.URL.indexOf(redirectUri);

                    if (pos === 0) {
                        url = win.document.URL;
                        win.close();
                        clearInterval(repeat);
                        controller.getTokenFromUrl(url);
                    }
                }, 100);
            }

    },

    getToken: function(accessCode) {
        var controller = this;
        Ext.Ajax.request({
            url: 'https://www.googleapis.com/oauth2/v4/token',
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            method: 'POST',
            params: {
                code: accessCode,
                client_id: clientId,
                client_secret: clientSecret,
                redirect_uri: redirectUri,
                grant_type: 'authorization_code'
            },

            callback: function(options, success, response) {
                console.log('Get token response '+response.status);
                if (response.status != 200) {
                    console.log(response.responseText);
                }

                if (response.responseText) {
                    var json = Ext.util.JSON.decode(response.responseText);
                    accessToken = json['access_token'];
                    controller.getUserInfo(accessToken);
                }
            }
        });
    },

    getUserInfo: function(accessToken) {
        var controller = this;
        Ext.Ajax.request({
            url: 'https://www.googleapis.com/oauth2/v3/userinfo',
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            },
            params: {
                access_token : accessToken
            },

            callback: function(options, success, response) {
                var json = Ext.util.JSON.decode(response.responseText);
                controller.onLoginSuccess(json['email']);
            }
        });
    },

    getTokenFromUrl: function(url) {
            var access_code = /\?code=(.+)$/.exec(url)[1];
            var error = /\?error=(.+)$/.exec(url);
            if (access_code) {
                this.getToken(access_code);
            }
    },

    onLoginSuccess: function(email) {

         Ext.Viewport.setActiveItem('profilePanel');
        //var profile = Ext.Create({})
    },

    launch: function() {
        Ext.Viewport.add(Ext.create('PixonicTeam.view.Profile'));
        Ext.Viewport.setActiveItem('loginpanel');
    }

});