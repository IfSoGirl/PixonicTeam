{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userAlias": "loginController",
        "designer|userClassName": "LoginController",
        "requires": [
            "Ext.Ajax",
            "PixonicTeam.view.Profile"
        ]
    },
    "name": "MyController",
    "designerId": "1ac66694-44e0-4510-ac74-a68180d744ca",
    "cn": [
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "loginBtn",
                "selector": "#loginBtn"
            },
            "name": "loginBtn",
            "designerId": "8f5d01bd-d454-4c02-b65a-666c60f32dfc"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "[action=confirm]",
                "designer|targetType": "Ext.Button",
                "fn": "onButtonTap",
                "implHandler": [
                    "    var params = 'client_id=' + encodeURIComponent(clientId);",
                    "    params += '&redirect_uri='+encodeURIComponent(redirectUri);",
                    "    params += '&response_type=code';",
                    "    params += '&access_type=offline';",
                    "    params += '&scope=' + encodeURIComponent(scopes);",
                    "    var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' + params;",
                    "    var win = window.open(authUrl, '_blank', 'location=no,toolbar=no,width=800, height=800');",
                    "    gwin = win;",
                    "    var context = this, url;",
                    "    var controller = this;",
                    "",
                    "",
                    "    if ((Ext.os.is.Android) || (Ext.os.is.iOS)) {",
                    "        win.addEventListener('loadstart', function (data) {",
                    "            var pos =  data.url.indexOf(redirectUri);",
                    "            if (pos === 0) {",
                    "                win.close();",
                    "                url = data.url;",
                    "                controller.getTokenFromUrl(url);",
                    "            }",
                    "        });",
                    "    }",
                    "    else {",
                    "        var repeat = setInterval(function () {",
                    "            var pos = -1;",
                    "            if(!win || !win.document){",
                    "                return;",
                    "            }",
                    "            if (win)",
                    "               pos =  win.document.URL.indexOf(redirectUri);",
                    "",
                    "            if (pos === 0) {",
                    "                url = win.document.URL;",
                    "                win.close();",
                    "                clearInterval(repeat);",
                    "                controller.getTokenFromUrl(url);",
                    "            }",
                    "        }, 100);",
                    "    }",
                    ""
                ],
                "name": "tap"
            },
            "name": "onButtonTap",
            "designerId": "a65220c2-bf42-477e-8476-7376c2c124d4"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "loginPanel",
                "selector": "#loginPanel"
            },
            "name": "loginPanel",
            "designerId": "543354b3-f72b-4e2b-909b-c03eaab579c0"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "accessCode"
                ],
                "fn": "getToken",
                "implHandler": [
                    "var controller = this;",
                    "Ext.Ajax.request({",
                    "    url: 'https://www.googleapis.com/oauth2/v4/token',",
                    "    headers: {",
                    "        \"Content-Type\": \"application/x-www-form-urlencoded\"",
                    "    },",
                    "    method: 'POST',",
                    "    params: {",
                    "        code: accessCode,",
                    "        client_id: clientId,",
                    "        client_secret: clientSecret,",
                    "        redirect_uri: redirectUri,",
                    "        grant_type: 'authorization_code'",
                    "    },",
                    "",
                    "    callback: function(options, success, response) {",
                    "        console.log('Get token response '+response.status);",
                    "        if (response.status != 200) {",
                    "            console.log(response.responseText);",
                    "        }",
                    "        ",
                    "        if (response.responseText) {",
                    "            var json = Ext.util.JSON.decode(response.responseText);",
                    "            accessToken = json['access_token'];",
                    "            controller.getUserInfo(accessToken);",
                    "        }",
                    "    }",
                    "});"
                ]
            },
            "name": "getToken",
            "designerId": "fdb9da38-a019-4d5c-aa31-27c03dc07bb2"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "accessToken"
                ],
                "fn": "getUserInfo",
                "implHandler": [
                    "var controller = this;",
                    "Ext.Ajax.request({",
                    "    url: 'https://www.googleapis.com/oauth2/v3/userinfo',",
                    "    method: 'GET',",
                    "    headers: {",
                    "        \"Content-Type\": \"application/json\"",
                    "    },",
                    "    params: {",
                    "        access_token : accessToken",
                    "    },",
                    "",
                    "    callback: function(options, success, response) {",
                    "        var json = Ext.util.JSON.decode(response.responseText);",
                    "        controller.onLoginSuccess(json['email']);",
                    "    }",
                    "});"
                ]
            },
            "name": "getUserInfo",
            "designerId": "e3e76b6c-db00-401e-b5bc-aeaa629d48b7"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "successAuth",
                "selector": "#successAuthLabel"
            },
            "name": "successAuth",
            "designerId": "e5c1e553-6120-4092-a761-3b1de85226e6"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "errorLabel",
                "selector": "#errorLabel"
            },
            "name": "errorLabel",
            "designerId": "e38b5820-e6c7-4790-83ee-70f7f851f1bf"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "url"
                ],
                "fn": "getTokenFromUrl",
                "implHandler": [
                    "    var access_code = /\\?code=(.+)$/.exec(url)[1];",
                    "    var error = /\\?error=(.+)$/.exec(url);",
                    "    if (access_code) {",
                    "        this.getToken(access_code);",
                    "    }"
                ]
            },
            "name": "getTokenFromUrl",
            "designerId": "63b747e1-f4b3-45b5-b9da-74c7ff3022d6"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "email"
                ],
                "fn": "onLoginSuccess",
                "implHandler": [
                    "",
                    " Ext.Viewport.setActiveItem('profilePanel');",
                    "//var profile = Ext.Create({})"
                ]
            },
            "name": "onLoginSuccess",
            "designerId": "e2f94bcc-5c8e-4c82-82de-efc32f0c891f"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "mainPanel",
                "selector": "#profilePanel"
            },
            "name": "mainPanel",
            "designerId": "d6f61c92-d43d-456c-a5b2-08d2087b4220"
        },
        {
            "type": "fixedfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "launch",
                "implHandler": [
                    "Ext.Viewport.add(Ext.create('PixonicTeam.view.Profile'));",
                    "Ext.Viewport.setActiveItem('loginpanel');"
                ]
            },
            "name": "launch",
            "designerId": "eeaa9db2-5b6d-4000-b80f-7bd6d4a3bbf9"
        }
    ]
}